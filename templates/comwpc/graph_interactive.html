{% extends "admin/base_site.html" %}

{% block extrahead %}
{{ block.super }}
<style>
    .subgraph-modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        height: 80%;
        background: white;
        z-index: 10000;
        border: 2px solid #ccc;
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
        overflow: auto;
    }

    .modal-content {
        padding: 20px;
        height: calc(100% - 40px);
    }

    .close-modal {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        cursor: pointer;
        z-index: 10001;
    }

    .modal-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
    }

</style>
{% endblock %}

{% block content %}
<div style="margin: 20px;">
    <h1>{{ graph.name }}</h1>
    <div style="width: 100%; overflow: auto; border: 1px solid #ddd; padding: 10px;">
        {{ svg_content|safe }}
    </div>
    <div style="margin-top: 20px;">
        <a href="{% url 'admin:comwpc_graph_change' graph.id %}" class="button">Вернуться к редактированию</a>
    </div>
</div>

<!-- Модальное окно для подграфов -->
<div id="subgraph-modal" class="subgraph-modal">
    <span class="close-modal">&times;</span>
    <div class="modal-content" id="subgraph-content"></div>
</div>

<div id="modal-backdrop" class="modal-backdrop"></div>

<div id="execution-controls">
    <button id="btn-start" class="btn btn-primary">
        <i class="fas fa-play"></i> Запустить
    </button>
    <button id="btn-pause" class="btn btn-secondary" disabled>
        <i class="fas fa-pause"></i> Пауза
    </button>
    <div class="progress mt-2">
        <div id="execution-progress" class="progress-bar" role="progressbar"></div>
    </div>
</div>

<script>

// Функция для открытия подграфа в модальном окне
function openSubgraph(graphId) {
    // Показываем модальное окно и подложку
    const modal = document.getElementById('subgraph-modal');
    const backdrop = document.getElementById('modal-backdrop');
    const content = document.getElementById('subgraph-content');

    // Заголовок загрузки
    content.innerHTML = '<h2>Загрузка графа...</h2>';

    // Показываем элементы
    modal.style.display = 'block';
    backdrop.style.display = 'block';

    // Загружаем содержимое графа
    fetch(`/graph-visualization/${graphId}/`)
        .then(response => response.text())
        .then(data => {
            // Извлекаем только содержимое блока content
            const parser = new DOMParser();
            const doc = parser.parseFromString(data, 'text/html');
            const contentBlock = doc.querySelector('.content');

            if (contentBlock) {
                content.innerHTML = contentBlock.innerHTML;
            } else {
                content.innerHTML = '<h2>Ошибка загрузки графа</h2>';
            }
        })
        .catch(error => {
            content.innerHTML = `<h2>Ошибка: ${error.message}</h2>`;
        });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Функция сбора начальных данных
function collectInitialData() {
    const initialData = {};

    // Сбор данных из элементов ввода
    document.querySelectorAll('.data-input').forEach(input => {
        const key = input.dataset.key;
        const value = input.value;

        // Попытка преобразовать в число
        if (!isNaN(value) && value.trim() !== '') {
            initialData[key] = parseFloat(value);
        } else {
            initialData[key] = value;
        }
    });

    // Добавьте здесь другие источники данных при необходимости
    // initialData['additional_param'] = 'some value';

    return initialData;
}


// Закрытие модального окна
document.querySelector('.close-modal').addEventListener('click', function() {
    document.getElementById('subgraph-modal').style.display = 'none';
    document.getElementById('modal-backdrop').style.display = 'none';
});

// Закрытие при клике на подложку
document.getElementById('modal-backdrop').addEventListener('click', function() {
    document.getElementById('subgraph-modal').style.display = 'none';
    this.style.display = 'none';
});

document.addEventListener('DOMContentLoaded', function() {
    const sessionId = "{{ execution_session|default_if_none:'' }}";
    const eventSource = sessionId ? new EventSource(`/execution/events/${sessionId}/`) : null;

    // Обработка событий выполнения
    if (eventSource) {
        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            switch(data.event) {
                case 'start':
                    handleExecutionStart(data);
                    break;

                case 'state_enter':
                    highlightState(data.state, true);
                    updateDataPanel(data.data);
                    break;

                case 'state_exit':
                    highlightState(data.state, false);
                    break;

                case 'complete':
                    handleExecutionComplete(data);
                    break;
            }
        };
    }

    // Запуск выполнения
    document.getElementById('btn-start').addEventListener('click', async () => {
        try {
            const response = await fetch(`/graph/{{ graph.id }}/start/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    data: collectInitialData()
                })
            });

            if (!response.ok) {
                throw new Error(`Ошибка сервера: ${response.status}`);
            }

            const result = await response.json();
            window.location.href = `?session=${result.session_id}`;

        } catch (error) {
            console.error('Ошибка при запуске выполнения:', error);
            alert('Не удалось запустить выполнение. Проверьте консоль для деталей.');
        }
    });

    // Функция подсветки состояния
    function highlightState(stateName, isActive) {
        const node = document.querySelector(`[data-name="${stateName}"]`);
        if (node) {
            if (isActive) {
                node.classList.add('state-active');
                node.scrollIntoView({behavior: 'smooth', block: 'center'});
            } else {
                node.classList.remove('state-active');
            }
        }
    }

    // Функция обновления панели данных
    function updateDataPanel(data) {
        const dataPanel = document.getElementById('data-panel');
        dataPanel.innerHTML = '';

        for (const [key, value] of Object.entries(data)) {
            const item = document.createElement('div');
            item.className = 'data-item';
            item.innerHTML = `<strong>${key}:</strong> ${JSON.stringify(value)}`;
            dataPanel.appendChild(item);
        }
    }
});
</script>

<style>
.state-active {
    stroke: #ff5722;
    stroke-width: 3px;
    filter: drop-shadow(0 0 8px rgba(255, 87, 34, 0.7));
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { stroke-width: 3px; }
    50% { stroke-width: 5px; }
    100% { stroke-width: 3px; }
}

#data-panel {
    position: fixed;
    right: 20px;
    top: 20px;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    max-width: 300px;
    max-height: 400px;
    overflow: auto;
    z-index: 1000;
}
</style>
{% endblock %}